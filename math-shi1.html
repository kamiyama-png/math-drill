<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã•ã‚“ã™ã†ã‚¯ã‚¨ã‚¹ãƒˆï¼ã€œçœŸãƒ»ä¼èª¬ã®ç§°å·ã€œ</title>
    <style>
        :root {
            --primary: #ffcc00; --secondary: #4cd137; --accent: #00a8ff;
            --bg: #f0f4f8; --danger: #ff4757;
        }
        body { font-family: "Hiragino Maru Gothic ProN", "Yu Gothic", sans-serif; background-color: var(--bg); margin: 0; padding: 10px; }
        #quiz-container { background: white; width: 100%; max-width: 600px; margin: 20px auto; padding: 25px; border-radius: 30px; border: 6px solid var(--accent); box-shadow: 0 10px 0 var(--accent); position: relative; }
        
        .screen { display: none; text-align: center; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ä¿®æ­£ï¼šç¥ç¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #celebration { 
            position: absolute; 
            top: 20%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 71, 87, 0.95); color: white; 
            padding: 15px 40px; border-radius: 50px;
            font-size: 1.8em; font-weight: bold; white-space: nowrap; 
            display: none; z-index: 1000; /* æœ€å‰é¢ã« */
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            pointer-events: none; /* ä¸‹ã®ãƒœã‚¿ãƒ³æ“ä½œã‚’é‚ªé­”ã—ãªã„ */
        }
        .pop-animation { animation: popCenter 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popCenter { 
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -60%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -60%) scale(1); opacity: 0; }
        }

        .start-msg { background: #fffdf0; padding: 20px; border-radius: 15px; border: 2px solid var(--primary); margin: 20px 0; line-height: 1.8; text-align: left; }
        .progress-bar { background: #eee; height: 18px; border-radius: 10px; margin-bottom: 20px; overflow: hidden; border: 2px solid #ddd; }
        .progress-fill { background: linear-gradient(90deg, var(--secondary), #8cf07a); height: 100%; width: 0%; transition: 0.5s; }
        .question-card { background: #fffdf0; padding: 25px; border-radius: 20px; border: 3px dashed var(--primary); margin-bottom: 25px; text-align: center; font-weight: bold; font-size: 1.3em; line-height: 1.8; }
        
        /* åˆ†æ•°è¡¨ç¤º */
        .frac-container { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 5px; line-height: 1; }
        .frac { display: inline-block; text-align: center; vertical-align: middle; }
        .frac span { display: block; padding: 0 4px; }
        .frac .num { border-bottom: 2px solid #333; padding-bottom: 2px; }
        .whole { font-size: 1.2em; margin-right: 2px; font-weight: bold; }

        .options { display: grid; grid-template-columns: 1fr; gap: 12px; }
        button.opt-btn { padding: 18px; font-size: 1.1em; border: 3px solid #e0e0e0; border-radius: 50px; background: white; cursor: pointer; transition: 0.2s; font-weight: bold; box-shadow: 0 5px 0 #ccc; }
        button.opt-btn:active { transform: translateY(4px); box-shadow: none; }
        button.opt-btn:hover { border-color: var(--accent); background: #f0faff; }

        .score-box { font-size: 4.5em; color: var(--danger); font-weight: bold; margin: 10px 0; }
        .badge { display: inline-block; padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-bottom: 20px; border: 4px solid #fff; box-shadow: 0 5px 0 rgba(0,0,0,0.1); font-size: 1.3em; color: white; }
        table.res-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 15px; overflow: hidden; }
        .res-table th { background: var(--accent); color: white; padding: 12px; }
        .res-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .retry-banner { background: var(--danger); color: white; padding: 15px; border-radius: 15px; margin: 20px 0; font-weight: bold; }
        .feedback-msg { height: 40px; margin-top: 15px; font-weight: bold; color: var(--danger); font-size: 1.2em; }
    </style>
</head>
<body>

<div id="quiz-container">
    <div id="celebration"></div>

    <div id="start-screen" class="screen active">
        <h1 style="color:var(--accent); font-size: 2em; margin-bottom: 10px;">ğŸ”± çœŸãƒ»ã•ã‚“ã™ã†ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
        <p style="color:#666; font-weight: bold;">ã€œå¤±ã‚ã‚ŒãŸæ•°å¼ã¨ä¼èª¬ã®ç§°å·ã€œ</p>
        <div class="start-msg">
            ã‚ˆããæ¥ãŸã€è‹¥ãè³¢è€…ã‚ˆã€‚<br>
            ã“ã®å…ˆã«ã¯ã€è¨ˆç®—ã®ç½ ã€å°æ•°ã®è¿·å®®ã€ãã—ã¦æ‰‹å¼·ã„æ–‡ç« é¡ŒãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹ã€‚å…¨å•æ­£è§£ã—ã€<b>ã€ŒçœŸãƒ»ç®—æ•°ã‚´ãƒƒãƒ‰ã€</b>ã®ç§°å·ã‚’æ´ã¿å–ã‚Œï¼
        </div>
        <button class="opt-btn" style="width:100%; background:var(--secondary); color:white; border-color:#38ac2a; box-shadow:0 5px 0 #38ac2a;" onclick="startGame()">ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ï¼</button>
    </div>

    <div id="game-screen" class="screen">
        <h2 style="text-align:center; color:var(--accent); margin-top:0;">ğŸŒŸ å†’é™ºé€²è¡Œä¸­</h2>
        <div class="progress-bar"><div class="progress-fill" id="fill"></div></div>
        <div id="q-area" class="question-card"></div>
        <div id="opt-area" class="options"></div>
        <div id="hint-box" style="display:none; margin-top:15px; padding:15px; background:#fff3cd; border-radius:10px; font-size:0.95em; border-left: 5px solid var(--primary); text-align: left;"></div>
    </div>

    <div id="result-screen" class="screen">
        <h1>ğŸ† å†’é™ºã®çµæœ«</h1>
        <div id="score-val" class="score-box">0ç‚¹</div>
        <div id="badge-area" class="badge">ç§°å·</div>
        <div id="eval-text" style="margin-bottom:20px; font-weight:bold; color:#555;"></div>
        <table class="res-table">
            <thead><tr><th>å•</th><th>åˆ¤å®š</th><th>æ­£è§£</th></tr></thead>
            <tbody id="res-list"></tbody>
        </table>
        <div id="retry-info" class="retry-banner" style="display:none;">ã€Œè©¦ç·´ã®ãƒªãƒ™ãƒ³ã‚¸ã€3å•ã«æŒ‘ã‚ï¼</div>
        <button class="opt-btn" style="width:100%; margin-top:20px; background:var(--accent); color:white; border-color:#0086cc; box-shadow:0 5px 0 #0086cc;" onclick="startRetry()">æ¬¡ã«ã™ã™ã‚€</button>
    </div>

    <div id="retry-screen" class="screen">
        <h1 style="color:var(--danger);">ğŸ”¥ è©¦ç·´ã®åˆ»</h1>
        <div id="retry-prog-text" style="font-weight:bold; margin-bottom:15px; color:#666;"></div>
        <div id="retry-q-area" class="question-card"></div>
        <div id="retry-opt-area" class="options"></div>
        <div id="retry-feedback" class="feedback-msg"></div>
    </div>
</div>

<script>
let current = 0; let score = 0; let userLogs = []; let wrongIdx = []; let retryStep = 0;

const f = (w, n, d) => `<span class="frac-container">${w > 0 ? `<span class="whole">${w}</span>` : ''}<span class="frac"><span class="num">${n}</span><span class="den">${d}</span></span></span>`;

const congratsMessages = ["å®Œç’§ã ï¼", "æã‚ã—ã„æ‰èƒ½...", "å…¨çŸ¥å…¨èƒ½ã‹ï¼", "ã“ã‚Œãã‚´ãƒƒãƒ‰ï¼", "ç¾ã—ãæ­£è§£ï¼", "é³¥è‚ŒãŒç«‹ã£ãŸãï¼"];

const quizData = [
    { 
        q: `${f(2, 3, 4)} ï¼‹ ${f(1, 2, 3)}`, a: f(4, 5, 12), d: [f(3, 5, 7), f(4, 1, 12)], 
        h: "åˆ†æ¯ã‚’12ã«ãã‚ãˆã‚ˆã†ï¼åˆ†å­ãŒ12ã‚’è¶…ãˆãŸã‚‰æ•´æ•°ã«ç¹°ã‚Šä¸Šã’ã‚‹ã®ã‚’å¿˜ã‚Œãšã«ï¼", 
        rq: `${f(1, 4, 5)} ï¼‹ ${f(1, 1, 2)}`, ra: f(3, 3, 10), rd: [f(2, 5, 7), f(3, 1, 10)] 
    },
    { 
        q: `${f(3, 1, 5)} ï¼ ${f(1, 2, 3)}`, a: f(1, 8, 15), d: [f(2, 1, 2), f(1, 7, 15)], 
        h: "åˆ†æ¯ã‚’15ã«ï¼åˆ†å­ã®å¼•ãç®—ãŒã§ããªã„ã¨ãã¯ã€æ•´æ•°ã‹ã‚‰1å€Ÿã‚Šã¦ã“ã‚ˆã†ï¼", 
        rq: `${f(4, 1, 4)} ï¼ ${f(1, 2, 3)}`, ra: f(2, 7, 12), rd: [f(3, 1, 1), f(2, 5, 12)] 
    },
    { q: `( â–¡ ï¼ 18 ) Ã— 7 ï¼ 126`, a: "36", d: ["30", "42"], h: "126Ã·7 ã‚’è¨ˆç®—ã—ã¦ã€ãã®å¾Œã«18ã‚’è¶³ãã†ï¼", rq: `( â–¡ ï¼ 12 ) Ã— 8 ï¼ 160`, ra: "32", rd: ["20", "40"] },
    { q: `0.15 Ã— 2.4 Ã· 0.6`, a: "0.6", d: ["0.06", "6"], h: "å‰ã‹ã‚‰é †ç•ªã«ã€‚å°æ•°ã®ä½ç½®ã‚’é–“é•ãˆãªã„ã‚ˆã†ã«ï¼", rq: `0.12 Ã— 4.5 Ã· 0.9`, ra: "0.6", rd: ["0.06", "6"] },
    { q: `150å„„ ã® 0.04å€ ã¯ï¼Ÿ`, a: "6å„„", d: ["6000ä¸‡", "60å„„"], h: "150 Ã— 0.04 ã‚’è¨ˆç®—ã—ã¦å˜ä½ã‚’ã¤ã‘ã‚ˆã†ï¼", rq: `200å„„ ã® 0.005å€ ã¯ï¼Ÿ`, ra: "1å„„", rd: ["1000ä¸‡", "10å„„"] },
    { q: `0.001 ã‚’ 1500å€‹é›†ã‚ãŸæ•°ã¯ï¼Ÿ`, a: "1.5", d: ["15", "0.15"], h: "å°æ•°ç‚¹ã‚’å·¦ã«3ã¤å‹•ã‹ã—ã¦ã¿ã‚ˆã†ï¼", rq: `0.01 ã‚’ 250å€‹é›†ã‚ãŸæ•°ã¯ï¼Ÿ`, ra: "2.5", rd: ["25", "0.25"] },
    { q: `ç§’é€Ÿ20m ã§ 3åˆ†èµ°ã‚‹ã¨ä½•kmï¼Ÿ`, a: "3.6km", d: ["60km", "3600km"], h: "ã¾ãšã¯ã€Œ3åˆ†ï¼180ç§’ã€ã«ç›´ã—ã¦è·é›¢ã‚’å‡ºãã†ï¼æœ€å¾Œã¯mã‚’kmã«ï¼", rq: `åˆ†é€Ÿ80m ã§ 1æ™‚é–“èµ°ã‚‹ã¨ä½•kmï¼Ÿ`, ra: "4.8km", rd: ["48km", "800m"] },
    { 
        q: `${f(0, 45, 6)} ã‚’å¸¯åˆ†æ•°ã«ã—ã€ã•ã‚‰ã«ç´„åˆ†ã›ã‚ˆ`, a: f(7, 1, 2), d: [f(7, 3, 6), f(7, 2, 3)], 
        h: "ã¾ãšã¯å¸¯åˆ†æ•°ã«ç›´ã—ã¦ã‹ã‚‰ï¼ˆ45Ã·6ï¼‰ã€åˆ†æ•°éƒ¨åˆ†ã‚’åŒã˜æ•°ã§å‰²ã‚ã†ï¼", 
        rq: `${f(0, 28, 8)} ã‚’å¸¯åˆ†æ•°ã«ã—ç´„åˆ†ã›ã‚ˆ`, ra: f(3, 1, 2), rd: [f(3, 4, 8), f(3, 2, 4)] 
    },
    { q: `1ã‹ã‚‰100ã¾ã§ã«ã€Œ7ã€ãŒã¤ãæ•°å­—ã¯ä½•å€‹ï¼Ÿ`, a: "19å€‹", d: ["10å€‹", "20å€‹"], h: "ä¸€ã®ä½ãŒ7ã®æ•°ã¨ã€åã®ä½ãŒ7ã®æ•°ã‚’æ•°ãˆã‚ˆã†ï¼ˆ77ã«æ³¨æ„ï¼‰ï¼", rq: `1ã‹ã‚‰50ã¾ã§ã«ã€Œ3ã€ãŒã¤ãæ•°å­—ã¯ä½•å€‹ï¼Ÿ`, ra: "15å€‹", rd: ["5å€‹", "14å€‹"] },
    { q: `æ± ã®å‘¨ã‚Š1.2kmã‚’ã€Aå›ã¯åˆ†é€Ÿ80mã€Bå›ã¯åˆ†é€Ÿ70mã§åŒã˜å ´æ‰€ã‹ã‚‰åå¯¾ã«æ­©ãã¨ä½•åˆ†å¾Œã«å‡ºä¼šã†ï¼Ÿ`, a: "8åˆ†å¾Œ", d: ["10åˆ†å¾Œ", "15åˆ†å¾Œ"], h: "1.2kmã‚’1200mã«ç›´ã—ã€äºŒäººã®é€Ÿã•ã®ã€Œå’Œã€ã§å‰²ã‚ã†ï¼", rq: `600mã®é“ã‚’Aå›åˆ†é€Ÿ60mã€Bå›åˆ†é€Ÿ40mã§å‘ã‹ã„åˆã†ã¨ä½•åˆ†å¾Œï¼Ÿ`, ra: "6åˆ†å¾Œ", rd: ["10åˆ†å¾Œ", "5åˆ†å¾Œ"] }
];

function switchScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function startGame() {
    switchScreen('game-screen');
    showQ();
}

function showCeleb() {
    const el = document.getElementById("celebration");
    el.innerText = congratsMessages[Math.floor(Math.random() * congratsMessages.length)];
    el.style.display = "block";
    el.classList.remove("pop-animation");
    void el.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    el.classList.add("pop-animation");
    setTimeout(() => { el.style.display = "none"; }, 800);
}

function showQ() {
    const data = quizData[current];
    document.getElementById("fill").style.width = (current * 10) + "%";
    document.getElementById("q-area").innerHTML = (current + 1) + ". " + data.q;
    document.getElementById("hint-box").style.display = "none";
    const area = document.getElementById("opt-area");
    area.innerHTML = "";
    [...data.d, data.a].sort(() => Math.random() - 0.5).forEach(o => {
        const b = document.createElement("button");
        b.className = "opt-btn"; b.innerHTML = o;
        b.onclick = () => {
            if(o === data.a) {
                showCeleb();
                if(!userLogs[current]) { score += 10; userLogs[current] = { s: "ã€‡", v: o }; }
                setTimeout(() => { current++; if(current < 10) showQ(); else end(); }, 800);
            } else {
                userLogs[current] = { s: "Ã—", v: o };
                if(!wrongIdx.includes(current)) wrongIdx.push(current);
                document.getElementById("hint-box").innerHTML = "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: " + data.h;
                document.getElementById("hint-box").style.display = "block";
            }
        };
        area.appendChild(b);
    });
}

function end() {
    switchScreen('result-screen');
    document.getElementById("score-val").innerText = score + "ç‚¹";
    const b = document.getElementById("badge-area");
    const e = document.getElementById("eval-text");
    
    if(score === 100) { b.innerText = "ğŸ‘‘ çœŸãƒ»ç®—æ•°ã‚´ãƒƒãƒ‰"; b.style.background = "linear-gradient(#45aaf2, #2d98da)"; e.innerText = "é©šç•°çš„ãªçŸ¥èƒ½ï¼ã‚‚ã¯ã‚„æ•™ãˆã‚‹ã“ã¨ã¯ä½•ã‚‚ãªã„ï¼"; }
    else if(score >= 80) { b.innerText = "ğŸ’ è³¢è€…ã®é¨å£«"; b.style.background = "#a55eea"; e.innerText = "ãƒã‚¤ãƒ¬ãƒ™ãƒ«ãªå•é¡Œã‚’ã“ã“ã¾ã§è§£ãã¨ã¯ï¼"; }
    else if(score >= 60) { b.innerText = "âš”ï¸ ç†Ÿç·´ã®æˆ¦å£«"; b.style.background = "#20bf6b"; e.innerText = "ã‚ã¨ä¸€æ­©ï¼è¤‡é›‘ãªè¨ˆç®—ã«æ…£ã‚Œã¦ããŸã­ï¼"; }
    else if(score >= 30) { b.innerText = "ğŸ›¡ï¸ é›éŒ¬ä¸­ã®å…µå£«"; b.style.background = "#f7b731"; e.innerText = "ã“ã®é›£å•ãªã‚‰ååˆ†ãªå¥é—˜ï¼ãƒªãƒ™ãƒ³ã‚¸ã§çŸ¥è­˜ã‚’å®šç€ã•ã›ã‚ˆã†ï¼"; }
    else { b.innerText = "ğŸ£ å†’é™ºã®åµ"; b.style.background = "#eb3b5a"; e.innerText = "é›£ã—ã‹ã£ãŸã‹ãªï¼Ÿãƒãƒ¼ãƒˆã«æ›¸ã„ã¦è¨ˆç®—ã—ã¦ã¿ã‚ˆã†ï¼"; }
    
    if(score < 100) document.getElementById("retry-info").style.display = "block";
    const list = document.getElementById("res-list"); list.innerHTML = "";
    quizData.forEach((q, i) => {
        list.innerHTML += `<tr><td>${i+1}</td><td>${userLogs[i].s}</td><td style="font-size:0.8em">${q.a}</td></tr>`;
    });
}

function startRetry() {
    if(score === 100) { location.reload(); return; }
    switchScreen('retry-screen');
    showRetry();
}

function showRetry() {
    document.getElementById("retry-prog-text").innerText = `â˜… è©¦ç·´ ${retryStep + 1} / 3 å•ç›® â˜…`;
    let idx = (retryStep < wrongIdx.length) ? wrongIdx[retryStep] : Math.floor(Math.random() * 10);
    const data = quizData[idx];
    document.getElementById("retry-q-area").innerHTML = data.rq;
    document.getElementById("retry-feedback").innerText = "";
    const area = document.getElementById("retry-opt-area"); area.innerHTML = "";
    [...data.rd, data.ra].sort(() => Math.random() - 0.5).forEach(o => {
        const b = document.createElement("button");
        b.className = "opt-btn"; b.innerHTML = o;
        b.onclick = () => {
            if(o === data.ra) {
                document.getElementById("retry-feedback").innerHTML = "âœ¨ è©¦ç·´çªç ´ï¼ãŠè¦‹äº‹ï¼";
                setTimeout(() => { retryStep++; if(retryStep < 3) showRetry(); else { alert("è©¦ç·´å®Œäº†ï¼ã‚ãªãŸã¯çœŸã®è³¢è€…ã§ã™ï¼"); location.reload(); } }, 800);
            } else { document.getElementById("retry-feedback").innerText = "âŒ ã¾ã ä¿®è¡ŒãŒè¶³ã‚Šã¬ï¼å†è¨ˆç®—ã ï¼"; }
        };
        area.appendChild(b);
    });
}
</script>
</body>
</html>